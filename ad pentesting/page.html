<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>AD pentesting</title>
</head><body>Managed Services Accounts (gMSAs), which changes passwords after every 30 days. You can learn more about it here (https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed).<br/>
Attackers use various corporate password-compromise techniques, including brute force, dictionary, password spraying, credential attacks etc. All organisations must have a strict password policy to defend against all such attacks. Password policies mean different rules for creating passwords, including length, complexity, and changing frequency. For viewing and configuring the password policy, you can use the following:<br/>
- Local Group Policy Editor > Computer Configuration > Windows Settings > Security Settings > Account Po Securing Authentication Methtods LAN Manager Hash: the user account password for Windows isn't stored in clear text; instead, it stores passwords with two types of hash representation. When the password for any user account is changed or set with fewer than 15 characters, both LM hash (LAN Manager hash) and NT hash (Windows NT hash) are generated by Windows and can be stored in AD. The LM hash is relatively weaker than the NT and is prone to a fast brute-force attack. The best recommendation is to prevent Windows from storing the password's LM hash. You can access it through the following:<br/>
- Local Group Policy Editor > Computer Configuration > Windows Settings > Security Settings > Local Policies > Security Options > double click Network security - Do not store LM hash value on next password change policy > select "Define policy setting"<br/>
SMB Signing: Microsoft-based networks utilise SMB for file and print communication. Moreover, it allows secure transmission over the network. Configuring SMB signing through group policy is crucial to detect Man in the Middle (MiTM) attacks that may result in modification of SMB traffic in transit. SMB signing ensures the integrity of data for both client and server. All supported Windows versions have an SMB packet signing option.<br/>
- Local Group Policy Editor > Computer Configuration > Windows Settings > Security Settings > Local Policies > Security Options > double click Microsoft network server: Digitally sign communication (always) > select Enable Digitally Sign Communications<br/>
LDAP Signing: Light Weight Directory Access Protocol (LDAP) enables locating and authenticating resources on the network. Hackers may introduce replay or MiTM attacks to launch custom LDAP requests. Therefore, LDAP signing is a Simple Authentication and Security Layer (SASL) property that only accepts signed LDAP requests and ignores other requests (plain-text or non-SSL). We can enable LDAP signing through the following:<br/>
- Local Group Policy Editor > Computer Configuration > Windows Settings > Security Settings > Local Policies > Security Options > Domain controller: LDAP server signing requirements > select Require signing from the dropdown<br/>
Password Rotation: Active Directory password security is critical to address because of security breaches and password reuse. It becomes challenging for any organisation to reset account passwords or update them everywhere, so they prefer not to do it. This scenario could have a few alternate approaches, and each method has pros and cons.<br/>
- First Technique: Creating a script to update passwords automatically in the Scheduled Task with the help of PowerShell. This method does not require any additional overhead and removes all the manual efforts for password rotation, but it requires you to write and maintain your script - which could be challenging.<br/>
- Second Technique: Add a Multi-Factor Authentication (MFA) solution to AD and choose not to change the password often. It adds a security layer, and you will not need to change your password often. You can read more about implementing MFA here (https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-getstarted).<br/>
- Third Technique: Microsoft provides a solution for services account password rotation through Group Managed Services Accounts (gMSAs), which changes passwords after every 30 days. You can learn more about it here (https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed).<br/>
Attackers use various corporate password-compromise techniques, including brute force, dictionary, password spraying, credential attacks etc. All organisations must have a strict password policy to defend against all such attacks. Password policies mean different rules for creating passwords, including length, complexity, and changing frequency. For viewing and configuring the password policy, you can use the following:<br/>
- Local Group Policy Editor > Computer Configuration > Windows Settings > Security Settings > Account Po Managed Services Accounts (gMSAs), which changes passwords after every 30 days. You can learn more about it here (https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed).<br/>
Attackers use various corporate password-compromise techniques, including brute force, dictionary, password spraying, credential attacks etc. All organisations must have a strict password policy to defend against all such attacks. Password policies mean different rules for creating passwords, including length, complexity, and changing frequency. For viewing and configuring the password policy, you can use the following:<br/>
- Local Group Policy Editor > Computer Configuration > Windows Settings > Security Settings > Account Policies > Password Policy<br/>

Implementing Least Privilege Model<br/>
Implementing the least privilege model requires limiting the user or application access to minimise security risks and attack surface. It requires setting up the different account types for diverse purposes. The principle of minimal privilege or the principle of least authority, requires that in a particular abstraction layer of a computing environment, every module (such as a process, a user, or a program, depending on the subject) must be able to access only the information and resources that are necessary for its legitimate purpose. It includes the following account types:<br/>
- User accounts: You must promote using regular user accounts for most people in the network, who are necessary to perform their regular duties.<br/>
- Privilege accounts: These are the accounts with elevated privileges and are further classified as first and second privilege accounts.<br/>
- Shared accounts: These accounts are shared amongst a group of people, as the visitors with bare minimum privileges, to give limited access for a specific time. These accounts are not recommended and must be utilised in limited scenarios.<br/>
Tiered Access Model<br/>
The Active Directory Tiered Access Model (TAM) comprises plenty of technical controls that reduce the privilege escalation risks. It consists of a logical structure that separates Active Directory's assets by creating boundaries for security purposes. The primary goal is the protection of Active Directory's top-valued identities (Tier 0). At the same time, domain members and other users can perform routine tasks, such as email checking, surfing the internet, and using apps and other services (Tier 1, 2). It comprises three tiers, Tier 0, 1, and 2, which are as follows:<br/>
- Tier 0 (Domain Accounts): Top level and includes all the admin accounts, Domain Controller, and groups.<br/>
- Tier 1 (Server Admins): Domain member applications and servers. <br/>
- Tier 2 (Workstation Admins): End-user devices like HR and sales staff (non-IT personnel).<br/>
The critical implementation of this model is based on the principle of "Prevention of privileged credentials from crossing boundaries, either accidentally or intentionally". Implementing technical controls via Group Policy Objects is crucial to avoid such scenarios. These Group Policy Objects put together the security rights that can deny access or grant permission. You can read more about the Tiered and Enterprise Access Model (EAM) here (https://docs.microsoft.com/en-us/security/compass/privileged-access-access-model).<br/>
Auditing Accounts<br/>
Accounts audit is a crucial task mainly carried out by setting up the correct account, assigning privileges, and applying restrictions. Three audit types related to accounts must be done periodically: usage, privilege, and change audits.<br/>
- Usage audits allow monitoring each account's specific tasks and validating their access rights.<br/>
- A privilege audit allows you to check if every account in the system has the least privilege.<br/>
- Change audits allow you to look for any improper changes to account permissions, passwords, or settings. Any unacceptable change to these may lead to a data breach.<br/>

Microsoft Security Compliance Toolkit<br/>
Microsoft Security Compliance Toolkit (MSCT) is an official toolkit provided by Microsoft to implement and manage local and domain-level policies. You don't have to worry about complex policy syntaxes and scripts, as Microsoft will provide pre-developed security baselines per the end user environment. You can download MSCT from the official Microsoft website link.<br/>
Microsoft offers its customers security baselines readily available in consumable formats, like, Group Policy Objects Backups. You can easily download it as zip files and extract the content. Here is how you can download and install the security baselines for Windows Server in a simple way:<br/>
- Open Microsoft Security Compliance Website > click Download > click Windows Servers Security Baseline.zip > Download<br/>
- Open extracted folder > Scripts > and select desired baseline and execute with PowerShell<br/>

Policy Analyser<br/>
One of the Security Compliance ToolKit's features is a policy analyser which allows comparison of group policies to quickly check inconsistencies, redundant settings, and the alterations that need to be made between them. Consider a scenario where plenty of GPOs are applied at diverse levels. There will be conflicting, redundant settings and many more avenues that can be quickly resolved with a policy analyser (https://www.microsoft.com/en-us/download/details.aspx?id=55319).<br/>
Once downloaded, you can run the "PolicyAnalyzer.exe" to add and manage local or domain-level policies. Be careful while downloading security baselines, as they should only be downloaded from the official Microsoft website.<br/>

Protecting Against Known Attacks<br/>
Kerberoasting<br/>
Kerberoasting is a common and successful post-exploitation technique for attackers to get privileged access to AD. The attacker exploits Kerberos Ticket Granting Service (TGS) to request an encrypted password, and then the attacker cracks it offline through various brute force techniques. These attacks are difficult to detect as the request is made through an approved user, and no unusual traffic pattern is generated during this process. You can prevent the attack by ensuring an additional layer of authentication through MFA or by frequent and periodic Kerberos Key Distribution Centre (KDC) service account password reset. You can learn more about the attack here (https://microsoft.com/security/blog/2020/08/27/stopping-active-directory-attacks-and-other-post-exploitation-behavior-with-amsi-and-machine-learning/).<br/>
Weak and Easy-to-Guess Passwords<br/>
The easiest target for intruders to breach security is the weak and easy-to-guess old passwords. The best recommendation is to use strong passwords and avoid already known ones. A strong password consists of a combination of uppercase and lowercase letters, numbers, and special characters. You can learn more about password strength here (https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-password-ban-bad-combined-policy). There are many tools available (like Enzoic) that can help you perform Password Auditing in AD.<br/>
Brute Forcing Remote Desktop Protocol<br/>
The intruders or attackers use scanning tools to brute force the weak credentials. Once the brute force is successful, they quickly access the compromised systems and try to do privilege escalation along with a persistent foothold in the target's computer. The best recommendation is to never expose RDP without additional security controls to the public internet. Continuous audits for scanning attacks or brute-force attempts are also an important step.<br/>
Publically Accessible Share<br/>
During AD configuration, some share folders are publicly accessible or left unauthenticated, providing an initial foothold for attackers for lateral movement. You can use the "Get-SmbOpenFile" cmdlet in PowerShell to look for any undesired share on the network and configure access accordingly.<br/>



in order to secure AD from responder attack of capturing user hashes, disable LLMNR and NBT-NS.<br/>
- to disable LLMNR, select "Turn OFF Multicast Name Resolution" under Local Computer Policy > Computer Configuration > Administrative Templates > Network > DNS Client in the Group Policy Editor.<br/>
- to disable NBT-NS, navigate to Network Connections > Network Adapter Properties > TCP/IPv4 Properties > Advanced tab > WINS tab and select "Disable NetBIOS over TCP/IP".<br/>
<br/>
if a company must use or cannot disable LLMNR/NBT-NS, the best course of action is to:<br/>
- require Network Access Control (like which MAC addresses are allowed).<br/>
- require string user password (e.g., >14 characters in length and limit common word usage). the more complex and long the password, the harder it is for an attacker to crack the hash.<br/>
<br/>
instead of cracking hashes gathered with Responder, we can instead relay those hashes to specific machines and potentially gain access. to do this, following conditions must be met:<br/>
- SMB signing must be disabled on the target.<br/>
- Relayed user credentials must be admin on the target machine.<br/>
<br/>
performing smb relay attack (grab a hash, relay it to another machine, if SMB signing is disabled then we can get on that machine as long as we are admin):<br/>
- 'network discovery and file sharing' must be enabled on the machines for this attack to work.<br/>
- go to responder configuration file (/usr/share/responder), and turn Off SMB and HTTP so that we are going to be listening and not responding on these servers.<br/>
- run responder<br/>
- point to a target machine from one windows machine to another (target) which will in turn fail and attack the machine of which the user in question is admin, and then dump the sensitive information.<br/>
</body></html>